<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Revisar Medicamento Donado</title>
        <link rel="stylesheet" href="/static/css/generic.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>

    <header>
        <div class="logo">
        <nav class="menu">
            
            <ul>
                <li><a href="/dashboard_administrador">Dashboard</a></li>
                <li><a href="/registro_usuarios">Gestion Usuarios</a></li>
                <li><a href="/registro_paciente_animal">Gestion Paciente</a></li>
                <li><a href="/gestion_insumos">Gestion Insumos</a></li>
                <li><a href="/registrar_animal_rescatado">Animales Rescatados</a></li>
                <li><a href="/medicamento">Gestion Medicamentos</a></li>
                <li><a href="/registrar_donacion">Donaciones</a></li>
            </ul>

            <div class="btn-group">
                <a href="{{ url_for('rutas_login.login') }}" class="btn-cupo"> Cerrar Sesi贸n</a>
            </div>
        </nav>
    </header>
</head>
<body>

    <h1>Revisi贸n de Medicamento Donado</h1>

    <div id="info-donacion">
        </div>

    <div class="acciones-revision">
        <button id="btn-aprobar">Aprobar y trasladar al inventario</button>
        
        <label for="justificacion_rechazo">Justificaci贸n de rechazo:</label>
        <input type="text" id="justificacion_rechazo">
        <button id="btn-descartar">Descartar</button>
    </div>
<footer>
        <div>
            Copyright 漏 2025 Developed by Trio Imperial co.
        </div>

        <div>
            Powered by Petfriendly
        </div>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const donacionId = window.location.pathname.split('/').pop();
            const infoDiv = document.getElementById('info-donacion');
            const btnAprobar = document.getElementById('btn-aprobar');
            const btnDescartar = document.getElementById('btn-descartar');
            const justificacionInput = document.getElementById('justificacion_rechazo');

            // 1. Cargar la informaci贸n de la donaci贸n espec铆fica
            try {
                const response = await fetch(`/donacion/${donacionId}`);
                if (!response.ok) {
                    throw new Error('Donaci贸n no encontrada.');
                }
                const donacion = await response.json();
                infoDiv.innerHTML = `
                    <p><strong>ID:</strong> ${donacion.id}</p>
                    <p><strong>Donante:</strong> ${donacion.nombre_donante}</p>
                    <p><strong>Medicamento:</strong> ${donacion.nombre_medicamento}</p>
                    <p><strong>Cantidad:</strong> ${donacion.cantidad} ${donacion.unidad_medida}</p>
                    <p><strong>Fecha de vencimiento:</strong> ${donacion.fecha_vencimiento || 'No aplica'}</p>
                    <p><strong>Estado actual:</strong> ${donacion.estado}</p>
                    <p><strong>Observaciones:</strong> ${donacion.observaciones || 'Ninguna'}</p>
                `;
            } catch (error) {
                infoDiv.innerHTML = `<p>${error.message}</p>`;
                return;
            }

            // 2. L贸gica para aprobar la donaci贸n
            btnAprobar.addEventListener('click', async () => {
                const confirmacion = confirm('驴Est谩 seguro de aprobar este medicamento para el inventario cl铆nico?');
                if (confirmacion) {
                    try {
                        const response = await fetch(`/revisar_donacion/${donacionId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ accion: 'aprobar' })
                        });
                        const resultado = await response.json();
                        if (response.ok) {
                            alert(resultado.mensaje);
                            window.location.href = '/consultar_donaciones.html'; // Redirigir a la vista de consulta
                        } else {
                            alert(`Error: ${resultado.error}`);
                        }
                    } catch (error) {
                        alert('Ocurri贸 un error al procesar la solicitud.');
                    }
                }
            });

            // 3. L贸gica para descartar la donaci贸n
            btnDescartar.addEventListener('click', async () => {
                const justificacion = justificacionInput.value;
                if (!justificacion) {
                    alert('Debe ingresar una justificaci贸n para descartar el medicamento.');
                    return;
                }
                const confirmacion = confirm('驴Est谩 seguro de descartar este medicamento?');
                if (confirmacion) {
                    try {
                        const response = await fetch(`/revisar_donacion/${donacionId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ accion: 'descartar', justificacion: justificacion })
                        });
                        const resultado = await response.json();
                        if (response.ok) {
                            alert(resultado.mensaje);
                            window.location.href = '/consultar_donaciones.html';
                        } else {
                            alert(`Error: ${resultado.error}`);
                        }
                    } catch (error) {
                        alert('Ocurri贸 un error al procesar la solicitud.');
                    }
                }
            });
        });
    </script>
</body>
</html>